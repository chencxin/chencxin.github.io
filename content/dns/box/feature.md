+++
title = "发展"
date =  2021-05-13T09:50:07+08:00
description= "发展"
weight = 5
+++

# 第一期

### 构建部署相关

#### 1、私有化集群

建设私有化集群是对外私有化部署解决方案的第一步。

- 一键部署
- 方便扩展
- 安全的配置
- 集群管理程序化

#### 2、统一网关（微服务）

目前仅有简单网关

缺失：
- 服务访问自动tls
- 自动代理注入
- 分布式追踪（应用依赖分析）
- 故障注入
- 负载均衡

应用状态可见性和可测试。
#### 2、持久存储

目前缺失

持久存储是有状态服务的基础。
持久化存储为数据库和应用提供高可用的数据服务。

- 高可用，高性能，稳定
- 一键部署


#### 3、监控报警

高可用、覆盖全面的监控系统是建设高可用服务的第一步。

监控可以让我们清晰的看到当前系统的运行状态，监控加报警可以提供紧急状态预警。

缺失：
- 应用自身状态数据缺失（希望看到应用的健康状态，请求量，延迟和关键指标数据）
- 组件状态数据缺失（每个组件的运行状态，请求量，延迟，报错等）
- 应用链路可见性监控

#### 4、日志

当前没有日志系统！

应用日志目前没有严格要求过，但应用有一个标准。

缺失：
- 日志收集，持久存储
- 日志查询
- 日志报警（sentry）
- 日志链路分析
- 分布式追踪系统

#### 5、构建部署

目前的构建部署自动化属于初级阶段。

缺失：
- k8s作为job, 将任务跑到k8s集群
- 接入有一定成本，有待优化
- 应用单元测试覆盖

#### 6、项目迭代优化

完善项目迭代流程，小步快走，快速迭代能力，以功能打造产品而不是版本。

越是复杂的系统，越需要系统间解耦。分开独立的迭代子系统，可以极大的减少系统bug。

#### 7、快速的对外应用部署能力

有了基础设施搭建还需要快速的应用部署能力。

operator sdk 和 kubebuilder

用于为kubernetes crd设置控制器/操作符代码库的两个主要工具。主要都是基于k8s的crd资源，差别不是很大，只有支持的特性多少差别。

应用改用 operator sdk 或 kubebuilder部署，提升应用的稳定性和更细粒度的可控性。

- operator 支持ansible和helm operators
- Kubebuilder包含一个envtest包，允许操作员开发人员使用独立的etcd和apiserver运行简单的测试。
- Kubebuilder搭建了一个Makefile来帮助用户完成操作任务(构建、测试、运行、代码生成等);操作员SDK目前使用内置子命令。每种方法都有优缺点。SDK团队将来可能会迁移到基于makefile的方法。
- Kubebuilder使用Kustomize来构建部署清单;Operator SDK使用带有占位符的静态文件。
-  Kubebuilder最近改进了对准入和CRD转换webhook的支持，这还没有进入operator SDK。

Kubebuilder 由k8s官方出品


### 业务相关

#### 1、统一鉴权服务，统一授权服务

使用同一的鉴权服务减少系统间的耦合和复杂性。
统一登录，服务间的认证统一


统一用户权限控制，将权限控制和业务代码解耦。

可编程的权限服务系统。

鉴权体系是所有系统的基础能力。

#### 2、统一事件处理的服务SDK

CloudEvents

通用标准事件数据分发，事件分发和接收通用标准。

一个框架支持多种格式：
- json
- kafka
- http
- nats
- websockets
- protobuf
- web hook

提供：
- 统一的类型系统，抽象类型，不与实际类型耦合
- 统一协议规范
- 监控及可见性
- 供跨服务、跨平台和跨系统

我们更换底层消息组件的阻力可能就差这一个统一的消息处理sdk。如果有一个统一的sdk，那么小心的定义和收发可以统一语义，有利于应用事件的高效设计。

#### 3、API设计优化

REST并不是唯一的api设计规范。

**REST vs GraphQL:**

- rest劣势1：今天开发的大多数web和移动应用程序都需要大量的数据，这些数据通常结合了相关的资源。问题是，使用基于rest的API访问所有数据以获得所需的一切需要多次往返。
- rest劣势2：开发人员在使用REST时面临的另一个常见问题是过度提取（获取太多数据）和提取不足(需要多次调用)。
- GraphQL与REST之间的关键区别是，GraphQL不处理专用资源。您可以使用GraphQL查询语言定制您的请求，以匹配您的确切需求。
- GraphQL使得前端产品的快速迭代成为可能，因为它允许开发人员在客户端进行更改，而不需要与服务器打交道。
- 使用GraphQL，开发人员能够深入了解后端请求的数据以及可用数据是如何被使用的。因为，使用GraphQL，每个客户机都确切地指定了它们需要的信息。
- GraphQL使用强类型系统定义api的功能，该系统本质上告诉客户端如何访问数据。
- GraphQL的主要缺点是使用单一端点而不是遵循HTTP规范进行缓存。
- graphql自带api文档，几乎不需要另外写。自带调用界面。


graphql更适合前端数据图表类应用，它可以定制查询数据。

rest:

```shell
GET /books/:id
GET /authors/:id
GET /books/:id/comments
POST /books/:id/comments
```

graphql:

```shell
type Query {
  book(id: ID!): Book
  author(id: ID!): Author
}

type Mutation {
  addComment(input: AddCommentInput): Comment
}

type Book { ... }
type Author { ... }
type Comment { ... }
input AddCommentInput { ... }
```

**REST vs gRPC:**

- gRPC低延迟
- 用于微服务间调用
- 低带宽
- 实现比rest慢，对于高速迭代的开发不适合


#### 4、提升数据分析能力提升

clickhouse只是数据的统计，并没有数据分析。

统计是已知数据标签，按照标签统计数数量。
数据分析是未知数据标签，找出潜在标签。

- ip资产分析，多维度用户画像
- 异常分析，DNS异常查找历史、响应内容和与其他数据源的相关性——包括对网站内容的主动分析等。
- dns分析类型1：威胁情报-识别恶意域(例如，抢注，命令和控制，被破坏的名称)。利用DNS分析生成新的威胁情报，可以用来阻止域名，阻止未来对恶意域名的访问。
- dns分析类型2：感染检测-检测受感染的端点(例如，可疑行为模式)。基于可疑的DNS行为快速发现被破坏的系统。越快地检测出被破坏的端点，就能越快地修复它们，从而限制所造成的损害。
- dns分析类型3：域名分类——域名的自动分类(例如，与不需要的已知域相似的域)。域名分类比威胁情报范围更广，因为领域可以被分类为赌博、游戏或其他分类标记，而不是明确地标记为恶意或非恶意。
- dns分析类型4：取证标记——为取证提供可操作的信息(例如，过去的查找和响应)。由于DNS是高度动态的，IP地址和名称之间的关联变化速度非常快，因此在进行威胁搜索或取证调查时，维护过去端点解决的IP地址的确切历史记录非常重要。

**dns主动监测：**

IBM: 《Stream Computing for Large-Scale, Multi-Channel Cyber Threat Analytics: Architecture, Implementation, Deployment, and Lessons Learned.》

关于检测快速流动和DGAs的研究。 （detect fast fluxing and DGAs published）

结合上面的四种分析类型和大量的dns流量，数字证书注册信息(domain name registration data (WHOIS) )，我们可以做很多分析：
- dns主动监测是一种从根本上不同的方法，用于在实际的安全威胁可见之前发现潜在的恶意域以及这些域背后的不良行动者。
- 威胁参与者通常通过应用生成方法来生成恶意域名，例如域名抢注。威胁前检测发现新注册的Quad9恶意域名，并识别域名背后的参与者。
- WHOIS信息和网站信息比对可以降低假阳性率
- 恶意域名的领域分布极其不均匀，针对不同领域分别防御。
- 内容和信息分析是基于一些快速的DNS查询流。用于检测DNS隧道，旨在识别DNS上的数据泄露和其他隐蔽通道。
- 通过识别DNS查询流量中的异常峰值，容量分析可用于检测可疑的DNS活动。良性域名的流量峰值通常在峰值前后有正常行为，而恶意域名的流量峰值则没有。通过描述IP地址的良性解析(常见使用)和恶意重绑定攻击之间的差异，体积DNS分析还可以用于检测DNS重绑定攻击。

**限制范围更加关注数据：**

DNS的体量分析很有效，但可以通过限制分析的范围来提高效率。
可检测的攻击主要通过两种dns方式：
- 1、攻击创建的新域名。
- 2、 现有的域名被劫持用于恶意活动。

使用fast fluxing，攻击者会快速循环通过大量不同的IP地址的域名，以避免被阻止。研究参考 《Scalable Analytics to Detect DNS Misuse for Establishing Stealthy Communication Channels》可以使用两种分析技术进行检测：MapReduce and Feature Collection and Correlation Engine (FCCE) 
另一种减少检测体量的方法是关注失败的域解析(NXDOMAIN)。在同一篇论文中被提到，这是一种对抗技术，恶意软件通过算法为其C&C服务器计算域，并试图解决这些域，直到找到一个活动服务器。查看失败的域名，查找计算特征：它是否是punycode-encoded，它包含的任何字典单词的语言，等等。利用这些特性，该技术计算出一个加权骗局

**被动dns分析**

- 威胁行为分析

#### 5、云原生分布式发布-订阅消息

Pulsar，大厂主推用于替换kafka。

